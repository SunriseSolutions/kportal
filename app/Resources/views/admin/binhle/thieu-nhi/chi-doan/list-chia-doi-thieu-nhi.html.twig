{% extends 'SonataAdminBundle:CRUD:base_list.html.twig' %}

{%- block actions -%}
{%- endblock -%}
{% block list_filters_actions %} {%- endblock -%}

    {% block list_filters %}
    {%- endblock -%}

{% block stylesheets %}
    {{ parent() }}

    {#<script src="https://code.jquery.com/jquery-1.11.1.min.js"></script>#}

    <link rel="stylesheet" media="screen" href="{{ asset('assets/vendor/handsontable/handsontable.min.css') }}">

    <link rel="stylesheet" media="screen"
          href="{{ asset('assets/vendor/handsontable/pikaday/pikaday.css') }}">


    <!-- Optional theme -->
    <link rel="stylesheet" href="{{ asset('assets/css/animate.css') }}"/>

    <style>
        ::-webkit-input-placeholder {
            color: red;
            text-align: center;
        }

        :-moz-placeholder {
            /* Firefox 18- */
            color: red;
            text-align: center;
        }

        ::-moz-placeholder {
            /* Firefox 19+ */
            color: red;
            text-align: center;
        }

        :-ms-input-placeholder {
            color: red;
            text-align: center;
        }
    </style>


    <style type="text/css">
        body {
            /*background: white;*/
            /*margin: 20px;*/
        }

        h2 {
            /*margin: 20px 0;*/
        }

        .handsontable .currentRow {
            background-color: #E7E8EF;
        }

        .handsontable .currentCol {
            background-color: #F9F9FB;
        }
    </style>

{% endblock %}

{% block javascripts %}
    {% set chiDoan = admin.actionParams['chiDoan'] %}

    {% set phanBoHangNam = chiDoan.phanBoHangNam %}
    {% set christianNames =  admin.actionParams['christianNames'] %}

    {{ parent() }}

    <script src="{{ asset('assets/vendor/handsontable/pikaday/pikaday.js') }}"></script>
    <script src="{{ asset('assets/vendor/handsontable/moment/moment.js') }}"></script>
    <script src="{{ asset('assets/vendor/handsontable/numbro/numbro.js') }}"></script>
    <script src="{{ asset('assets/vendor/handsontable/numbro/languages.js') }}"></script>
    <script src="{{ asset('assets/vendor/handsontable/handsontable.min.js') }}"></script>

    <!-- Latest compiled and minified JavaScript -->
    <script src="{{ asset('assets/js/bootstrap-notify.min.js') }}"></script>

    <script>
        $(document).ready(function () {

            window.data =
                [
                    {% for phanBo in phanBoHangNam %}
                    {% set thanhVien = phanBo.thanhVien %}
                    {% if thanhVien.thieuNhi is not empty %}
                    {% set phanBoTruoc = phanBo.phanBoTruoc %}
                    {% if phanBoTruoc is not empty %}
                    {% set bangDiemTruoc = phanBo.phanBoTruoc.bangDiem %}
                    {% if bangDiemTruoc is not empty %}
                    {% set diemNamTruoc = bangDiemTruoc.tbYear %}
                    {% set oLai = bangDiemTruoc.gradeRetention is empty?'':'Ở LẠI' %}
                    {% else %}
                    {% set diemNamTruoc = '---' %}
                    {% set oLai = '---' %}
                    {% endif %}

                    {% else %}
                    {% set diemNamTruoc =  'Mới tham gia' %}
                    {% set oLai = '' %}
                    {% endif %}
                    {#"{{ phanBo.id }}",#}
                    {% spaceless %}
                    ["{{ thanhVien.code }}", '{{ thanhVien.christianName }}', '{{ thanhVien.lastName }}', '{{ thanhVien.middleName }}', '{{ thanhVien.firstName }}', {{ diemNamTruoc }}, '', '{{ thanhVien.sex }}', '{{ oLai }}'],
                    {% endspaceless %}
                    {% endif %}
                    {% endfor %}
                ];


            var container = document.getElementById('chiDoanSpreadSheet'),
                hot;
            var container1 = document.getElementById('example1'),
                hot1;

            window.hot = new Handsontable(container, {
                data: window.data,
                columnSorting: true,
                currentRowClassName: 'currentRow',
                currentColClassName: 'currentCol',
                contextMenu: false,
                autoWrapRow: true,
                startRows: 7,
                startCols: 4,
                rowHeaders: true,
                afterChange: function (change, source) {
                    if (source === 'loadData') {
                        return; //don't save this change
                    }
//                    if (!autosave.checked) {
//                        return;
//                    }

                    changedRow = change[0][0];
                    var data = window.hot.getData();
                    console.log(data[changedRow][0]);
                    $.notify({
                        // options
                        message: ' Bé ' + data[changedRow][4] + ' (' + data[changedRow][0] + ') đã được xếp vào đội ' + data[changedRow][6]
                    }, {
                        // settings
                        type: 'success',
                        allow_dismiss: true,
                        delay: 7000,
                        newest_on_top: false,
                        showProgressbar: false,
                        placement: {
                            from: "top",
                            align: "center"
                        },
                    });
                }
                ,
                colHeaders: ['#', 'Tên Thánh', 'Họ', 'Tên Lót', 'Tên', 'Điểm ' + '{{ chiDoan.namHoc.id - 1 }}', 'Đội', 'Giới tính', 'Ở lại'],
                columns: [
                    {
                        readOnly: true
                    },
                    {
                        readOnly: true,
                        type: 'dropdown',
                        source: [
                            {% spaceless %}
                            {% for vn,en in christianNames %}
                            {{ loop.index > 1?',':'' }}
                            '{{ vn }}'
                            {% endfor %}
                            {% endspaceless %}
                        ]
                    },
                    {readOnly: true,},
                    {readOnly: true,},
                    {readOnly: true,},
                    {
                        readOnly: true,
                        type: 'numeric'
                    },
                    {
                        type: 'dropdown',
                        source: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12]
                    },
                    {
                        readOnly: true,
                        editor: 'select',
                        selectOptions: ['NAM', 'NỮ']
                    },
                    {}
                ]
            });

            function bindButtons() {

                Handsontable.dom.addEvent(document.body, 'click', function (e) {

                    var element = e.target || e.srcElement;

                    if (element.nodeName == "BUTTON" && element.name == 'save') {
                        var name = element.getAttribute('data-dump');
                        var instance = element.getAttribute('data-instance');
                        var hot = window[instance];
                        data = hot.getData();
                        console.log(window.data[0][0]);
                        window.data[0][0] = 'aaaaaaaaaaaaaa';
//                        console.log(name);
//                        console.log(instance);
                        console.log(window.data[0][0]);
                        console.log('data of ' + name, hot.getData());
                        hot.loadData(window.data);

                        $.notify({
                            // options
                            message: 'Dumping Data ' + name
                        }, {
                            // settings
                            type: 'success',
                            allow_dismiss: true,
                            delay: 7000,
                            newest_on_top: false,
                            showProgressbar: false,
                            placement: {
                                from: "top",
                                align: "center"
                            },
                        });
                    }
                });
            }

            bindButtons();

        });
    </script>
{% endblock %}

    {% block list_table %}
        <div class="col-xs-12 col-md-12">

            {# Add a margin if no pager to prevent dropdown cropping on window #}
            <div class="box box-primary" style="margin-bottom: 100px;">
                <div class="box-body no-padding">
                    <p>
                        {#
                        <button name="save" data-dump="#chiDoanSpreadSheet" data-instance="hot"
                                title="Undo" class="btn btn-primary" style="margin: 15px;"><i class="fa fa-floppy-o"
                                                                                              aria-hidden="true">
                                Lưu</i>
                        </button>

                        <button name="undo" data-dump="#chiDoanSpreadSheet" data-instance="hot"
                                title="Undo" class="btn btn-primary" style="margin: 15px;"><i class="fa fa-undo" aria-hidden="true"> Undo</i>
                        </button>
                        <button name="redo" data-dump="#chiDoanSpreadSheet" data-instance="hot"
                                title="Redo" class="btn btn-primary" style="margin: 15px;"><i class="fa fa-repeat" aria-hidden="true"> Redo</i>
                        </button>
                        #}
                    </p>

                    <div style="margin-left: 20px;" id="chiDoanSpreadSheet"
                         class="handsontable htColumnHeaders"></div>
                </div>
            </div>
        </div>


    {% endblock %}

    {% block sonata_admin_content_actions_wrappers %}
        <ul class="nav navbar-nav navbar-right">
            <li class="">
                {#<input type="button" class="btn btn-small btn-success" value="Import List" data-toggle="modal"#}
                {#data-target="#clinicImportJoinerModal" style="margin-top:8px;"/>#}
            </li>
        </ul>
        {{ parent() }}
    {% endblock sonata_admin_content_actions_wrappers %}